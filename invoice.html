<!doctype html>
<html lang="ht">
<head>
  <meta charset="utf-8" />
  <title>Express Lakay ‚Äî Faktirasyon</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1a237e"/>
  <style id="invoice-styles">
    :root{--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:#f8fafc;color:var(--ink)}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    .btn{background:#1a237e;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.alt{background:#fff;color:#1f2937;border:1px solid #e5e7eb}
    .bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .muted{color:var(--muted)}
    /* Invoice ‚Äúcanvas‚Äù */
    .sheet{background:#fff;border:1px solid var(--line);border-radius:14px;padding:28px}
    .row{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
    .logo{height:36px}
    h1.title{margin:0;font-size:24px;letter-spacing:.4px}
    .right{text-align:right}
    .meta{font-size:14px;color:#374151}
    .block{margin-top:22px;display:flex;gap:80px}
    .bcol h4{margin:0 0 8px;font-size:12px;color:#6b7280;letter-spacing:.08em}
    .bcol .name{font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:18px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:14px;vertical-align:top}
    th.r, td.r{text-align:right}
    tfoot td{border-top:2px solid var(--line);font-weight:800}
    .ipt{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font-size:14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .no-print{margin-top:10px}
    @media print {
      body{background:#fff}
      .no-print{display:none!important}
      .sheet{border:none;border-radius:0;padding:28px 16px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Aksyon -->
    <div class="bar no-print">
      <a class="btn alt" href="./index.html">‚Üê Ak√®y</a>
      <button class="btn" id="saveDraft">üíæ Sove</button>
      <button class="btn alt" id="printPdf">üñ®Ô∏è Print / PDF</button>
      <button class="btn alt" id="downloadPng">üñºÔ∏è Download PNG</button>
      <button class="btn alt" id="waShare">üü¢ WhatsApp</button>
      <span id="status" class="muted"></span>
    </div>

    <!-- F√íM -->
    <div class="sheet" id="invoice">
      <!-- Ent√®t -->
      <div class="row">
        <div style="display:flex;gap:12px;align-items:center">
          <img id="coLogo" class="logo" alt="logo"/>
        </div>
        <div class="right">
          <h1 class="title" id="docTitle">INVOICE</h1>
          <div class="meta"><span id="docNo">#</span></div>
          <div class="meta">Issued <span id="docDateText">‚Äî</span></div>
        </div>
      </div>

      <!-- FROM / BILL TO -->
      <div class="block">
        <div class="bcol">
          <h4>FROM</h4>
          <div class="name" id="coName">‚Äî</div>
          <div id="coPerson" class="muted"></div>
          <div id="coPhone" class="muted"></div>
          <div id="coEmail" class="muted"></div>
          <div id="coAddr" class="muted"></div>
        </div>
        <div class="bcol">
          <h4>BILL TO</h4>
          <div class="name" id="clNameShow">‚Äî</div>
          <div id="clPhoneShow" class="muted"></div>
          <div id="clEmailShow" class="muted"></div>
        </div>
      </div>

      <!-- TABLO Liy yo -->
      <table id="lines">
        <thead>
          <tr>
            <th>Description</th>
            <th class="r">QTY</th>
            <th class="r">Price, <span id="curHdr">USD</span></th>
            <th class="r">Amount, <span id="curHdr2">USD</span></th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="3" class="r">Total</td><td class="r" id="sumTotal">$0.00</td></tr>
        </tfoot>
      </table>
    </div>

    <!-- Z√≤n Antre done (senp, pa pre-ranpli) -->
    <div class="no-print" style="margin-top:12px">
      <div class="grid2">
        <div>
          <label>Konpayi</label>
          <select id="company" class="ipt"></select>
        </div>
        <div>
          <label>Tip dokiman</label>
          <select id="docType" class="ipt">
            <option value="INVOICE">FACTURE</option>
            <option value="PROFORMA">PROFORMA</option>
          </select>
        </div>
        <div>
          <label># Dokiman (vid = auto)</label>
          <input id="docNoInput" class="ipt" placeholder="ex. INV-2025-003">
        </div>
        <div>
          <label>Dat</label>
          <input id="docDate" type="date" class="ipt">
        </div>
        <div>
          <label>Kliyan ‚Äî Non</label>
          <input id="clName" class="ipt" placeholder="Non kliyan">
        </div>
        <div>
          <label>Telef√≤n (WhatsApp)</label>
          <input id="clPhone" class="ipt" placeholder="+509...">
        </div>
        <div>
          <label>Im√®l</label>
          <input id="clEmail" class="ipt" placeholder="client@email.com">
        </div>
        <div>
          <label>Deviz</label>
          <select id="currency" class="ipt">
            <option value="USD" selected>USD</option>
            <option value="HTG">HTG</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px">
        <button class="btn alt" id="addLine">+ Add line</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Donn√©es konpayi yo ----------
    const COMPANIES = [
      {
        id:'NEXAPAC',
        name:'Nexapac Haiti',
        logo:'./assets/nexapac-logo.png',
        person:'Geraly Mesidor',
        phone:'+50935782372',
        email:'nexapac8@gmail.com',
        addr:'Cap-Ha√Øtien'
      },
      {
        id:'RALYTECH',
        name:'RalyTech Digital Agency',
        logo:'./assets/ralytech-logo.png',
        person:'‚Äî',
        phone:'+509 33xx xxxx',
        email:'hello@ralytech.ht',
        addr:'Cap-Ha√Øtien'
      }
    ];

    // ---------- Utils ----------
    const el = id => document.getElementById(id);
    const fmt2 = n => Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    const saveLS = (k,v)=>localStorage.setItem('express_lakay_v1:'+k, JSON.stringify(v));
    const loadLS = (k,d=null)=>{try{return JSON.parse(localStorage.getItem('express_lakay_v1:'+k)) ?? d}catch{return d}};
    const sanitize = s => (s||'').toString().replace(/[^\w\-]+/g,'-').replace(/-+/g,'-').replace(/^-|-$|_/g,'').substring(0,60);

    // ---------- Populate select + init ----------
    COMPANIES.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;el('company').appendChild(o);});
    el('company').value = loadLS('invoice:lastCompany','NEXAPAC');
    el('docDate').valueAsDate = new Date();

    function applyCompany(){
      const C = COMPANIES.find(x=>x.id===el('company').value);
      el('coLogo').src = C.logo;
      el('coName').textContent = C.name;
      el('coPerson').textContent = C.person;
      el('coPhone').textContent = C.phone;
      el('coEmail').textContent = C.email;
      el('coAddr').textContent = C.addr;
      suggestNumber();
    }
    el('company').addEventListener('change', applyCompany);
    applyCompany();

    // ---------- Lines logic ----------
    const TB = document.querySelector('#lines tbody');
    function addLineRow(data={desc:'', qty:'', price:''}){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="ipt d" placeholder="Description" value="${data.desc||''}" style="width:100%"></td>
        <td class="r"><input class="ipt q" type="number" min="0" step="1" placeholder="" value="${data.qty||''}" style="width:120px"></td>
        <td class="r"><input class="ipt p" type="number" min="0" step="0.01" placeholder="" value="${data.price||''}" style="width:140px"></td>
        <td class="r amt">$0.00</td>
      `;
      TB.appendChild(tr);
      ['q','p','d'].forEach(cls=>tr.querySelector('.'+cls).addEventListener('input', compute));
      compute();
    }
    el('addLine').addEventListener('click', ()=>addLineRow({}));

    function compute(){
      const cur = el('currency').value;
      document.getElementById('curHdr').textContent = cur;
      document.getElementById('curHdr2').textContent = cur;

      let total = 0;
      [...TB.querySelectorAll('tr')].forEach(tr=>{
        const q = Number(tr.querySelector('.q').value||0);
        const p = Number(tr.querySelector('.p').value||0);
        const sub = q*p; total += sub;
        tr.querySelector('.amt').textContent = (cur==='USD'?'$':'')+fmt2(sub)+(cur==='HTG'?' HTG':'');
      });
      el('sumTotal').textContent = (cur==='USD'?'$':'')+fmt2(total)+(cur==='HTG'?' HTG':'');
      // Header mirroring (client)
      el('clNameShow').textContent = el('clName').value || '‚Äî';
      el('clPhoneShow').textContent = el('clPhone').value || '';
      el('clEmailShow').textContent = el('clEmail').value || '';
      // Meta header (# + date)
      const dt = el('docDate').value || new Date().toISOString().slice(0,10);
      el('docDateText').textContent = new Date(dt).toLocaleDateString('en-US');
      el('docTitle').textContent = el('docType').value === 'INVOICE' ? 'INVOICE' : 'PROFORMA';
      el('docNo').textContent = el('docNoInput').value ? '#'+el('docNoInput').value : '#‚Äî';
    }
    ['currency','clName','clPhone','clEmail','docType','docDate','docNoInput'].forEach(id=>el(id).addEventListener('input', compute));
    compute();

    // ---------- Auto numbering (per company/year) ----------
    function kCounter() {
      const year = (el('docDate').value||new Date().toISOString().slice(0,10)).slice(0,4);
      const type = el('docType').value; const co = el('company').value;
      return `invoice:counter:${co}:${type}:${year}`;
    }
    function peekNumber(){
      const n = (loadLS(kCounter(),0)||0)+1;
      const y = (el('docDate').value||new Date().toISOString().slice(0,10)).slice(0,4);
      const pref = el('docType').value==='INVOICE'?'INV':'PRO';
      return `${pref}-${y}-${String(n).padStart(3,'0')}`;
    }
    function nextNumber(){
      const k=kCounter(); const n=(loadLS(k,0)||0)+1; saveLS(k,n);
      el('docNoInput').value = peekNumber().replace(/-\d{3}$/, `-${String(n).padStart(3,'0')}`);
      compute();
    }
    function suggestNumber(){
      if(!el('docNoInput').value) el('docNoInput').placeholder = peekNumber();
    }
    ['company','docType','docDate'].forEach(id=>el(id).addEventListener('change', suggestNumber));
    suggestNumber();

    // ---------- Save draft ----------
    el('saveDraft').addEventListener('click', ()=>{
      if(!el('docNoInput').value) nextNumber();
      const draft = collectDoc();
      saveLS('invoice:lastDraft', draft);
      saveLS('invoice:lastCompany', el('company').value);
      el('status').textContent = `Saved ‚úì (#${draft.docNo})`;
      setTimeout(()=>el('status').textContent='',1500);
    });

    // ---------- Print / PDF ----------
    el('printPdf').addEventListener('click', ()=>{
      if(!el('docNoInput').value) nextNumber();
      window.print();
    });

    // ---------- WhatsApp ----------
    el('waShare').addEventListener('click', ()=>{
      if(!el('docNoInput').value) nextNumber();
      const d = collectDoc();
      const lines = d.items.slice(0,8).map(x=>`‚Ä¢ ${x.desc} √ó ${x.qty} = ${x.cur==='USD'?'$':''}${fmt2(x.sub)}${x.cur==='HTG'?' HTG':''}`).join('\n');
      const msg =
`${d.docType} ${d.docNo}
${d.company.name}
Issued ${new Date(d.docDate).toLocaleDateString('en-US')}
Total: ${(d.cur==='USD'?'$':'')+fmt2(d.total)+(d.cur==='HTG'?' HTG':'')}

${lines}

Kontak: ${d.company.phone} ‚Ä¢ ${d.company.email}`;
      const url = d.client.phone ? `https://wa.me/${d.client.phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}` : `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(url,'_blank');
    });

    // ---------- Download PNG (SVG foreignObject) ----------
    el('downloadPng').addEventListener('click', async ()=>{
      if(!el('docNoInput').value) nextNumber();
      const node = document.getElementById('invoice');
      const w = node.offsetWidth, h = node.offsetHeight;
      // Build standalone HTML for foreignObject
      const styles = document.getElementById('invoice-styles').innerHTML;
      const html = `
        <style>${styles}</style>
        <div class="sheet" style="border:none">${node.innerHTML}</div>
      `;
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
          <foreignObject width="100%" height="100%">
            ${html}
          </foreignObject>
        </svg>`;
      const svgBlob = new Blob([svg], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);
      const img = new Image(); img.crossOrigin='anonymous';
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        canvas.width = w*2; canvas.height = h*2;
        const ctx = canvas.getContext('2d');
        ctx.scale(2,2);
        ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,w,h);
        ctx.drawImage(img,0,0,w,h);
        URL.revokeObjectURL(url);
        canvas.toBlob(blob=>{
          const a=document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = fileBase()+'.png';
          a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
        }, 'image/png', 1);
      };
      img.src = url;
    });

    // ---------- Helpers: collect & filename ----------
    function collectDoc(){
      const C = COMPANIES.find(x=>x.id===el('company').value);
      const cur = el('currency').value;
      const items = [...TB.querySelectorAll('tr')].map(tr=>{
        const desc=tr.querySelector('.d').value.trim();
        const qty =Number(tr.querySelector('.q').value||0);
        const price=Number(tr.querySelector('.p').value||0);
        return {desc, qty, price, sub:qty*price, cur};
      }).filter(x=>x.desc||x.qty||x.price);
      const total = items.reduce((s,x)=>s+x.sub,0);
      return {
        company:C,
        docType: el('docType').value==='INVOICE'?'INVOICE':'PROFORMA',
        docNo: el('docNoInput').value,
        docDate: el('docDate').value || new Date().toISOString().slice(0,10),
        client: {name:el('clName').value.trim(), phone:el('clPhone').value.trim(), email:el('clEmail').value.trim()},
        items, total, cur
      };
    }
    function fileBase(){
      const d = collectDoc();
      const nm = sanitize(d.client.name||'client');
      const co = sanitize(d.company.name||'company');
      const date = d.docDate;
      return `${co}_${nm}_${d.docNo||'DOC'}_${date}`;
    }
    // Retire prefill any ‚Äî pa ajoute liy otomatik
  </script>
  <script>
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
